<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bloom Globe Game</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; color: white; font-family: "Syne", sans-serif; }
    #globeViz { width: 100vw; height: 100vh; }
    #sliderContainer {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-size: 1.05em;
    }
    input[type="range"] { width: 60%; }
    #playBtn { margin-top: 8px; padding: 8px 12px; border-radius: 8px; cursor: pointer; border: none; }
    /* HUD for game */
    #hud {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 10px 16px;
      border-radius: 10px;
      text-align: center;
    }
    #hud button {
      margin-top: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #ffb6c1;
      font-weight: bold;
    }
    /* Popup card for clicked location */
    #popup {
      position: absolute;
      top: 80px; left: 20px;
      background: white;
      color: black;
      padding: 10px 14px;
      border-radius: 8px;
      display: none;
      max-width: 200px;
      font-size: 0.9em;
    }
  </style>
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
</head>
<body>
  <div id="globeViz"></div>

  <div id="hud">
    <div id="mission">Mission:</div>
    <div>Score: <span id="score">0</span></div>
    <div>Time Left: <span id="timer">60</span>s</div>
    <div>Progress: <span id="progress">0</span></div>
    <button id="pauseBtn">Pause</button>
  </div>

  <div id="sliderContainer">
    <span id="monthLabel">January</span><br>
    <input id="monthSlider" type="range" min="0" max="11" step="1" value="0"><br>
    <button id="playBtn">▶ Play</button>
  </div>

  <div id="popup"></div>

  <script>
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    // Bloom colors (unchanged)
    const bloomColors = {
      Japan:      ["#e8eb49","#f5a2ac","#f484d4","#e647b9","#ab8aec","#d56de3","#e898ec","#f399f0","#de4242","#c27d37","#e16473","#f1ebb2"],
      Alaska:     ["#83b1dd","#649ac8","#a2d7ec","#6a5acd","#8f2da0","#d25db9","#cad239","#d9eaa5","#94dee1","#5cabcaff","#34879e","#4b6cb1"],
      Madagascar: ["#2e7d32","#4b9d4f","#6bc56f","#e1a2d6","#8be0dd","#98d6e7","#8ae5e5","#9adbed","#c71585","#edb232","#e2b330","#b288d1"],
      NewZealand: ["#ff1493","#ff1493","#ff8c00","#b22222","#b22222","#778899","#87ceeb","#ffb6c1","#ffff00","#e3e54e","#cb84c9","#b52212"],
      Fiji:       ["#ebe41f","#efa3ee","#e28ee8","#ef6cae","#ea9cd4","#da48c2","#ffffff","#ff4500","#ea8ecb","#edaa92","#eea58b","#e69a87"]
    };

    // Locations (unchanged)
    const locations = {
      Japan: [
        { lat: 35.6895, lng: 139.6917, label: "Tokyo" },
        { lat: 34.6937, lng: 135.5023, label: "Osaka" },
        { lat: 35.0116, lng: 135.7681, label: "Kyoto" },
        { lat: 43.06417, lng: 141.34694, label: "Sapporo" },
        { lat: 33.5902, lng: 130.4017, label: "Fukuoka" }
      ],
      Alaska: [
        { lat: 61.2181, lng: -149.9003, label: "Anchorage" },
        { lat: 64.8378, lng: -147.7164, label: "Fairbanks" },
        { lat: 58.3019, lng: -134.4197, label: "Juneau" },
        { lat: 64.5011, lng: -165.4064, label: "Nome" },
        { lat: 60.1042, lng: -149.4422, label: "Seward" }
      ],
      Madagascar: [
        { lat: -18.8792, lng: 47.5079, label: "Antananarivo" },
        { lat: -18.1494, lng: 49.4021, label: "Toamasina" },
        { lat: -15.7167, lng: 46.3167, label: "Mahajanga" },
        { lat: -23.3510, lng: 43.6667, label: "Toliara" },
        { lat: -12.2760, lng: 49.3110, label: "Antsiranana" }
      ],
      NewZealand: [
        { lat: -36.8485, lng: 174.7633, label: "Auckland" },
        { lat: -41.2865, lng: 174.7762, label: "Wellington" },
        { lat: -43.5321, lng: 172.6362, label: "Christchurch" },
        { lat: -45.8788, lng: 170.5028, label: "Dunedin" },
        { lat: -37.7832, lng: 175.2793, label: "Hamilton" }
      ],
      Fiji: [
        { lat: -18.1248, lng: 178.4501, label: "Suva" },
        { lat: -17.7768, lng: 177.4358, label: "Nadi" },
        { lat: -17.6160, lng: 177.4445, label: "Lautoka" },
        { lat: -18.8139, lng: 178.8458, label: "Levuka" },
        { lat: -16.4167, lng: 179.3833, label: "Labasa" }
      ]
    };

    // Ring animation params (unchanged)
    const numRipples = 12;
    const basePeriod = 12000;

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [ (bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255 ];
    }

    const GlobeObj = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .pointsData([])
      .pointAltitude(0)
      .pointLabel(d => d.label)
      .pointColor(d => d.color)
      .pointRadius(0.18)
      .ringsData([])
      .ringMaxRadius(d => d.maxR)
      .ringPropagationSpeed(d => d.speed)
      .ringRepeatPeriod(d => d.period)
      .ringColor(d => t => `rgba(${d.colorRGB[0]},${d.colorRGB[1]},${d.colorRGB[2]},${1 - t})`)
      .onPointClick(handleClick);

    GlobeObj(document.getElementById('globeViz'));
    GlobeObj.controls().autoRotate = true;
    GlobeObj.controls().autoRotateSpeed = 0.3;

    function updateForMonth(monthIndex) {
      document.getElementById('monthLabel').textContent = monthNames[monthIndex];
      const rings = [], points = [];

      for (const country of Object.keys(locations)) {
        const colorHex = bloomColors[country] ? bloomColors[country][monthIndex] : "#ffffff";
        const colorRGB = hexToRgb(colorHex);

        for (const loc of locations[country]) {
          points.push({ lat: loc.lat, lng: loc.lng, label: `${country} — ${loc.label}`, color: colorHex });
          for (let i = 0; i < numRipples; i++) {
            rings.push({ lat: loc.lat, lng: loc.lng, maxR: 3.5, speed: 2, period: basePeriod / (i + 1), colorRGB: colorRGB });
          }
        }
      }
      GlobeObj.pointsData(points);
      GlobeObj.ringsData(rings);
    }
    updateForMonth(0);

    const slider = document.getElementById('monthSlider');
    slider.addEventListener('input', e => updateForMonth(parseInt(e.target.value), 10));

    const playBtn = document.getElementById('playBtn');
    let isPlaying = false, playInterval = null;
    playBtn.addEventListener('click', () => {
      if (!isPlaying) {
        isPlaying = true;
        playBtn.textContent = '⏸ Pause';
        playInterval = setInterval(() => {
          let next = (parseInt(slider.value) + 1) % 12;
          slider.value = next;
          updateForMonth(next);
        }, 1000);
      } else {
        isPlaying = false;
        playBtn.textContent = '▶ Play';
        clearInterval(playInterval);
      }
    });

    // Game state
    const missions = [
      { key: "Japan", target: 5 },
      { key: "Alaska", target: 5 },
      { key: "Madagascar", target: 5 },
      { key: "NewZealand", target: 5 },
      { key: "Fiji", target: 5 }
    ];
    let currentMission = 0, collected = 0, score = 0, timeLeft = 60;
    let timer = null, paused = false;

    const missionEl = document.getElementById("mission");
    const scoreEl = document.getElementById("score");
    const timerEl = document.getElementById("timer");
    const progressEl = document.getElementById("progress");
    const pauseBtn = document.getElementById("pauseBtn");
    const popup = document.getElementById("popup");

    function startMission() {
      collected = 0;
      timeLeft = 60;
      missionEl.textContent = `Mission: Pollinate ${missions[currentMission].target} blooms in ${missions[currentMission].key}`;
      updateHUD();
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (!paused) {
          timeLeft--;
          updateHUD();
          if (timeLeft <= 0) endMission();
        }
      }, 1000);
    }

    function handleClick(bloom) {
      const mission = missions[currentMission];
      // Show popup card
      popup.style.display = "block";
      popup.textContent = `🌸 ${bloom.label}`;
      if (bloom.label.includes(mission.key)) {
        collected++;
        score += 100;
        updateHUD();
        if (collected >= mission.target) {
          score += 250;
          updateHUD();
          endMission();
        }
      }
    }

    function endMission() {
      clearInterval(timer);
      currentMission++;
      if (currentMission < missions.length) {
        setTimeout(startMission, 2000);
      } else {
        missionEl.textContent = "🎉 All missions complete!";
      }
    }

    function updateHUD() {
      scoreEl.textContent = score;
      timerEl.textContent = timeLeft;
      progressEl.textContent = `${collected}/${missions[currentMission].target}`;
    }

    pauseBtn.addEventListener("click", () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "Resume" : "Pause";
      GlobeObj.controls().autoRotate = !paused;
    });

    startMission();
  </script>
</body>
</html>

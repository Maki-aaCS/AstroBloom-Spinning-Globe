<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bloom Globe — gamified</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; color: white; font-family: "Syne", sans-serif; }
    #globeViz { width: 100vw; height: 100vh; }
    #sliderContainer {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-size: 1.05em;
    }
    input[type="range"] { width: 60%; }
    #playBtn { margin-top: 8px; padding: 8px 12px; border-radius: 8px; cursor: pointer; border: none; }
    #scoreboard {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.9);
      color: black;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
    }
    #timer {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      color: black;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
    }
    #popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      color: black;
      padding: 20px;
      border-radius: 12px;
      display: none;
      z-index: 1000;
      max-width: 250px;
      text-align: center;
    }
    #popup button {
      margin-top: 10px;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
</head>
<body>
  <div id="globeViz"></div>
  <div id="scoreboard">Score: <span id="score">0</span></div>
  <div id="timer">Time: 0s</div>
  <div id="sliderContainer">
    <span id="monthLabel">January</span><br>
    <input id="monthSlider" type="range" min="0" max="11" step="1" value="0"><br>
    <button id="playBtn">▶ Play</button>
  </div>
  <div id="popup">
    <div id="popupContent"></div>
    <button onclick="closePopup()">Close</button>
  </div>

  <script>
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    const bloomColors = {
      Japan:      ["#e8eb49","#f5a2ac","#f484d4","#e647b9","#ab8aec","#d56de3","#e898ec","#f399f0","#de4242","#c27d37","#e16473","#f1ebb2"],
      Alaska:     ["#83b1dd","#649ac8","#a2d7ec","#6a5acd","#8f2da0","#d25db9","#cad239","#d9eaa5","#94dee1","#5cabcaff","#34879e","#4b6cb1"],
      Madagascar: ["#2e7d32","#4b9d4f","#6bc56f","#e1a2d6","#8be0dd","#98d6e7","#8ae5e5","#9adbed","#c71585","#edb232","#e2b330","#b288d1"],
      NewZealand: ["#ff1493","#ff1493","#ff8c00","#b22222","#b22222","#778899","#87ceeb","#ffb6c1","#ffff00","#e3e54e","#cb84c9","#b52212"],
      Fiji:       ["#ebe41f","#efa3ee","#e28ee8","#ef6cae","#ea9cd4","#da48c2","#ffffff","#ff4500","#ea8ecb","#edaa92","#eea58b","#e69a87"]
    };

    const locations = {
      Japan: [
        { lat: 35.6895, lng: 139.6917, label: "Tokyo" },
        { lat: 34.6937, lng: 135.5023, label: "Osaka" },
        { lat: 35.0116, lng: 135.7681, label: "Kyoto" },
        { lat: 43.06417, lng: 141.34694, label: "Sapporo" },
        { lat: 33.5902, lng: 130.4017, label: "Fukuoka" }
      ],
      Alaska: [
        { lat: 61.2181, lng: -149.9003, label: "Anchorage" },
        { lat: 64.8378, lng: -147.7164, label: "Fairbanks" },
        { lat: 58.3019, lng: -134.4197, label: "Juneau" },
        { lat: 64.5011, lng: -165.4064, label: "Nome" },
        { lat: 60.1042, lng: -149.4422, label: "Seward" }
      ],
      Madagascar: [
        { lat: -18.8792, lng: 47.5079, label: "Antananarivo" },
        { lat: -18.1494, lng: 49.4021, label: "Toamasina" },
        { lat: -15.7167, lng: 46.3167, label: "Mahajanga" },
        { lat: -23.3510, lng: 43.6667, label: "Toliara" },
        { lat: -12.2760, lng: 49.3110, label: "Antsiranana" }
      ],
      NewZealand: [
        { lat: -36.8485, lng: 174.7633, label: "Auckland" },
        { lat: -41.2865, lng: 174.7762, label: "Wellington" },
        { lat: -43.5321, lng: 172.6362, label: "Christchurch" },
        { lat: -45.8788, lng: 170.5028, label: "Dunedin" },
        { lat: -37.7832, lng: 175.2793, label: "Hamilton" }
      ],
      Fiji: [
        { lat: -18.1248, lng: 178.4501, label: "Suva" },
        { lat: -17.7768, lng: 177.4358, label: "Nadi" },
        { lat: -17.6160, lng: 177.4445, label: "Lautoka" },
        { lat: -18.8139, lng: 178.8458, label: "Levuka" },
        { lat: -16.4167, lng: 179.3833, label: "Labasa" }
      ]
    };

    const numRipples = 12;
    const basePeriod = 12000;

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [ (bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255 ];
    }

    const GlobeObj = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .pointsData([])
      .pointAltitude(0)
      .pointLabel(d => d.label)
      .pointColor(d => d.color)
      .pointRadius(0.18)
      .ringsData([])
      .ringMaxRadius(d => d.maxR)
      .ringPropagationSpeed(d => d.speed)
      .ringRepeatPeriod(d => d.period)
      .ringColor(d => t => `rgba(${d.colorRGB[0]},${d.colorRGB[1]},${d.colorRGB[2]},${1 - t})`);

    GlobeObj(document.getElementById('globeViz'));
    GlobeObj.controls().autoRotate = true;
    GlobeObj.controls().autoRotateSpeed = 0.3;

    function updateForMonth(monthIndex) {
      document.getElementById('monthLabel').textContent = monthNames[monthIndex];
      const rings = [], points = [];

      for (const country of Object.keys(locations)) {
        const colorHex = bloomColors[country] ? bloomColors[country][monthIndex] : "#ffffff";
        const colorRGB = hexToRgb(colorHex);

        for (const loc of locations[country]) {
          points.push({ lat: loc.lat, lng: loc.lng, label: `${country} — ${loc.label}`, color: colorHex });
          for (let i = 0; i < numRipples; i++) {
            rings.push({ lat: loc.lat, lng: loc.lng, maxR: 3.5, speed: 2, period: basePeriod / (i + 1), colorRGB: colorRGB });
          }
        }
      }
      GlobeObj.pointsData(points);
      GlobeObj.ringsData(rings);
    }

    updateForMonth(0);

    const slider = document.getElementById('monthSlider');
    slider.addEventListener('input', e => updateForMonth(parseInt(e.target.value), 10));

    // --- Play / Pause ---
    const playBtn = document.getElementById('playBtn');
    let isPlaying = false, playInterval = null;

    playBtn.addEventListener('click', () => {
      if (!isPlaying) {
        isPlaying = true;
        playBtn.textContent = '⏸ Pause';
        playInterval = setInterval(() => {
          let next = (parseInt(slider.value) + 1) % 12;
          slider.value = next;
          updateForMonth(next);
        }, 1000);
        GlobeObj.controls().autoRotate = true;
        timerRunning = true; // resume timer
      } else {
        isPlaying = false;
        playBtn.textContent = '▶ Play';
        clearInterval(playInterval);
        GlobeObj.controls().autoRotate = false;
        timerRunning = false; // pause timer
      }
    });

    // SCORE SYSTEM
    let score = 0;
    const scoreDisplay = document.getElementById("score");

    // Track which places have already been clicked
    const clickedLocations = new Set();

    GlobeObj.onPointClick(point => {
      if (!clickedLocations.has(point.label)) {
        clickedLocations.add(point.label);   // Mark as visited
        score += 100;
        scoreDisplay.textContent = score;
        showPopup("Yay, you've pollinated " + point.label + " ! 🌱");
      } else {
        // Show popup: Already pollinated, No points
        showPopup(point.label + " already pollinated! No points this time ❌");
      }
    });

    function showPopup(text) {
      const popup = document.getElementById("popup");
      document.getElementById("popupContent").textContent = text;
      popup.style.display = "block";
    }
    function closePopup() {
      document.getElementById("popup").style.display = "none";
    }

    // Timer
    let seconds = 0;
    let timerRunning = true;
    const timerEl = document.getElementById("timer");

    setInterval(() => {
      if (timerRunning) {
        seconds++;
        timerEl.textContent = "Time: " + seconds + "s";
      }
    }, 1000);

    // Point pulsing animation 
    (function pulsePoints() {
      const t = Date.now() * 0.002;
      GlobeObj.pointRadius(0.15 + Math.abs(Math.sin(t)) * 0.06);
      requestAnimationFrame(pulsePoints);
    })();
  </script>
</body>
</html>


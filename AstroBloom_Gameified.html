<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pollinator Globe Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      margin: 0; 
      background: black; 
      font-family: 'Syne', sans-serif; 
      overflow: hidden;
    }
    #globeViz { 
      width: 100vw; 
      height: 100vh; 
    }
    #hud {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 12px 20px;
      border-radius: 12px;
      color: white;
      text-align: center;
    }
    #hud button {
      margin-top: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #ffb6c1;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>
  <div id="hud">
    <div id="mission">Mission:</div>
    <div>Score: <span id="score">0</span></div>
    <div>Time Left: <span id="timer">60</span>s</div>
    <div>Progress: <span id="progress">0</span></div>
    <button id="pauseBtn">Pause</button>
  </div>

  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
  <script>
    // ---- Bloom Data Generator ----
    const bloomData = [];
    function addBloom(lat, lng, color, label, count=10, spread=3) {
      for (let i=0; i<count; i++) {
        bloomData.push({
          id: Math.random().toString(36).substr(2,9), // unique id
          lat: lat + (Math.random()-0.5)*spread,
          lng: lng + (Math.random()-0.5)*spread,
          color,
          label
        });
      }
    }
    addBloom(36.2,138.2,"#ffb6c1","Japan Bloom", 15, 5);        
    addBloom(48.8,2.3,"#87ceeb","France Bloom", 12, 6);      
    addBloom(40.7,-74.0,"#2e7d32","USA Bloom", 15, 5);   
    addBloom(-33.8,151.2,"#ff8c00","Australia Bloom", 15, 5); 
    addBloom(-17.7,178.1,"#ffd700","Fiji Bloom", 15, 5);        

    // ---- Missions ----
    const missions = [
      { location: "Japan", key: "Japan Bloom", target: 5 },
      { location: "France", key: "France Bloom", target: 4 },
      { location: "USA", key: "USA Bloom", target: 4 },
      { location: "Australia", key: "Australia Bloom", target: 3 },
      { location: "Fiji", key: "Fiji Bloom", target: 5 }
    ];

    let currentMission = 0;
    let collected = 0;
    let score = 0;
    let timeLeft = 60;
    let timer;
    let paused = false;

    const missionEl = document.getElementById("mission");
    const scoreEl = document.getElementById("score");
    const timerEl = document.getElementById("timer");
    const progressEl = document.getElementById("progress");
    const pauseBtn = document.getElementById("pauseBtn");

    // ---- Globe ----
    const GlobeObj = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .pointAltitude(0) 
      .pointRadius(0.35)
      .pointColor(d => d.color)
      .pointLabel(d => d.label)
      .ringsData(bloomData) 
      .ringColor(d => d.color)
      .ringMaxRadius(2.5)   
      .ringPropagationSpeed(1) 
      .ringRepeatPeriod(2000)
      .onPointClick(handleClick);

    GlobeObj(document.getElementById("globeViz"));
    GlobeObj.controls().autoRotate = true;
    GlobeObj.controls().autoRotateSpeed = 0.2;

    // ---- Game Logic ----
    function startMission() {
      collected = 0;
      timeLeft = 60;
      updateHUD();
      missionEl.textContent = `Mission: Visit ${missions[currentMission].target} blooms in ${missions[currentMission].location}`;

      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (!paused) {
          timeLeft--;
          updateHUD();
          if (timeLeft <= 0) endMission();
        }
      }, 1000);
    }

    function handleClick(bloom) {
      const mission = missions[currentMission];
      if (bloom.label.includes(mission.key)) {
        // successful pollination
        collected++;
        score += 100;
        // remove bloom from data so it can't be clicked twice
        const index = bloomData.findIndex(b => b.id === bloom.id);
        if (index > -1) bloomData.splice(index, 1);
        GlobeObj.pointsData([...bloomData]);
        GlobeObj.ringsData([...bloomData]);

        updateHUD();
        if (collected >= mission.target) {
          score += 250; // bonus
          updateHUD();
          endMission();
        }
      }
    }

    function endMission() {
      clearInterval(timer);
      currentMission++;
      if (currentMission < missions.length) {
        setTimeout(startMission, 2000); // short pause
      } else {
        missionEl.textContent = "ðŸŽ‰ All missions complete!";
      }
    }

    function updateHUD() {
      scoreEl.textContent = score;
      timerEl.textContent = timeLeft;
      progressEl.textContent = `${collected}/${missions[currentMission].target}`;
    }

    pauseBtn.addEventListener("click", () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "Resume" : "Pause";
    });

    // start first mission
    startMission();
  </script>
</body>
</html>

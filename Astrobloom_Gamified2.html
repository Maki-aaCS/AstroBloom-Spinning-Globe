<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bloom Globe — Gamified + Videos</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; color: white; font-family: "Syne", sans-serif; }
    #globeViz { width: 100vw; height: 100vh; }
    #sliderContainer {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-size: 1.05em;
    }
    input[type="range"] { width: 60%; }
    #playBtn { margin-top: 8px; padding: 8px 12px; border-radius: 8px; cursor: pointer; border: none; }
    #scoreboard {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255,255,255,0.9);
      color: black;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
    }

    /* Video modal */
    .video-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.75);
      z-index: 9999;
    }
    .video-modal.active { display:flex; }
    .video-box {
      width: min(900px, 95%);
      height: min(560px, 85%);
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .video-box iframe { width:100%; height:100%; border:0; }
    .video-close {
      position: absolute;
      top:8px; right:8px;
      background:rgba(255,255,255,0.12);
      color:#fff; border:0; padding:6px 10px; cursor:pointer;
      border-radius:6px; font-weight:600;
    }
  </style>
  <script src="https://unpkg.com/three"></script>
  <script src="https://unpkg.com/globe.gl"></script>
</head>
<body>
  <div id="globeViz"></div>
  <div id="scoreboard">Score: <span id="score">0</span></div>

  <div id="sliderContainer">
    <span id="monthLabel">January</span><br>
    <input id="monthSlider" type="range" min="0" max="11" step="1" value="0"><br>
    <button id="playBtn">▶ Play</button>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="video-modal">
    <div class="video-box">
      <button id="closeBtn" class="video-close">✕ Close</button>
      <iframe id="ytFrame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    const bloomColors = {
      Japan:      ["#e8eb49","#f5a2ac","#f484d4","#e647b9","#ab8aec","#d56de3","#e898ec","#f399f0","#de4242","#c27d37","#e16473","#f1ebb2"],
      Alaska:     ["#83b1dd","#649ac8","#a2d7ec","#6a5acd","#8f2da0","#d25db9","#cad239","#d9eaa5","#94dee1","#34879e","#4b6cb1"],
      Madagascar: ["#2e7d32","#4b9d4f","#6bc56f","#e1a2d6","#8be0dd","#98d6e7","#8ae5e5","#9adbed","#c71585","#edb232","#e2b330","#b288d1"],
      NewZealand: ["#ff1493","#ff1493","#ff8c00","#b22222","#b22222","#778899","#87ceeb","#ffb6c1","#ffff00","#e3e54e","#cb84c9","#b52212"],
      Fiji:       ["#ebe41f","#efa3ee","#e28ee8","#ef6cae","#ea9cd4","#da48c2","#ffffff","#ff4500","#ea8ecb","#edaa92","#eea58b","#e69a87"]
    };

    // Locations with videos
    const locations = {
      Japan: [
        { lat: 35.6895, lng: 139.6917, label: "Tokyo", videoUrl:"https://youtu.be/yVkI0pwqA1s?si=6WPiyNQlIDmOSlFr" },  //Tokyo: Yt vid owner blocked from website
        { lat: 34.6937, lng: 135.5023, label: "Osaka", videoUrl:"https://youtu.be/2WK68UCBX2k?si=bpwtg9bKmegLdeXv" }, //Osaka: Showing Auckland
        { lat: 35.0116, lng: 135.7681, label: "Kyoto", videoUrl:"https://www.youtube.com/watch?v=rCuCTFjRIJM" },  
        { lat: 43.06417, lng: 141.34694, label: "Sapporo", videoUrl:"https://www.youtube.com/watch?v=rbxiTQ0izTg" },
        { lat: 33.5902, lng: 130.4017, label: "Fukuoka", videoUrl:"https://www.youtube.com/watch?v=5JtLTHaPFDM" }
      ],
      Alaska: [
        { lat: 61.2181, lng: -149.9003, label: "Anchorage", videoUrl:"https://youtube.com/shorts/Hrrr12QfUt8" },
        { lat: 64.8378, lng: -147.7164, label: "Fairbanks", videoUrl:"https://youtube.com/shorts/LtT454zVegE" },
        { lat: 58.3019, lng: -134.4197, label: "Juneau", videoUrl:"https://youtu.be/ihFRWkqfEsY?si=mZZ6b4TDWsPiF6hu" },  //Juneau: Error
        { lat: 64.5011, lng: -165.4064, label: "Nome", videoUrl:"https://www.youtube.com/watch?v=SUcOTyYW5gE" },
        { lat: 60.1042, lng: -149.4422, label: "Seward", videoUrl:"https://www.youtube.com/watch?v=1gl8yMo5M5Q" }
      ],
      Madagascar: [
        { lat: -18.8792, lng: 47.5079, label: "Antananarivo", videoUrl:"https://youtu.be/VuVZt9INJ2E?si=z-ceJrRGSoVoaa9L" },  //Antananarivo: instagram video
        { lat: -18.1494, lng: 49.4021, label: "Toamasina", videoUrl:"https://www.youtube.com/watch?v=soLTJjM0K6E" },
        { lat: -15.7167, lng: 46.3167, label: "Mahajanga", videoUrl:"https://youtu.be/J8Ekvf6s6b8?si=G6r1wONYfXrN3M2X" }, //Mahajanga: TikTok image
        { lat: -23.3510, lng: 43.6667, label: "Toliara", videoUrl:"https://youtu.be/a7lnKhwnZko?si=pIr-0LjQsdxMB3YF" },   //Tolaira: shutterstock video
        { lat: -12.2760, lng: 49.3110, label: "Antsiranana", videoUrl:"https://youtu.be/sFauF1h3qa8?si=QGQGzQ02cNB3_eAg" }  //Antsiranana: Pinterest video
      ],
      NewZealand: [
        { lat: -36.8485, lng: 174.7633, label: "Auckland", videoUrl:"https://youtu.be/axitaaKf_BE" },
        { lat: -41.2865, lng: 174.7762, label: "Wellington", videoUrl:"https://youtube.com/shorts/4SEsyY_kM2o" }, 
        { lat: -43.5321, lng: 172.6362, label: "Christchurch", videoUrl:"https://youtu.be/lSEU1DI7VYE" },
        { lat: -45.8788, lng: 170.5028, label: "Dunedin", videoUrl:"https://youtube.com/shorts/4SEsyY_kM2o" },  
        { lat: -37.7832, lng: 175.2793, label: "Hamilton", videoUrl:"https://www.youtube.com/watch?v=0hx7FNVRVjg" }
      ],
      Fiji: [
        { lat: -18.1248, lng: 178.4501, label: "Suva", videoUrl:"https://youtu.be/si5tPjg92v4" },
        { lat: -17.7768, lng: 177.4358, label: "Nadi", videoUrl:"https://youtu.be/si5tPjg92v4" },
        { lat: -17.6160, lng: 177.4445, label: "Lautoka", videoUrl:"https://youtu.be/ws36V6Kp1II?si=-Fgi8pEUvfwBBX6n" }, //Lautoka: Video is from facebook
        { lat: -18.8139, lng: 178.8458, label: "Levuka", videoUrl:"https://www.youtube.com/watch?v=TvWC6wY468c" },
        { lat: -16.4167, lng: 179.3833, label: "Labasa", videoUrl:"https://youtu.be/Y8DmlSdkZ7M?si=9Vnijvqh1oyfUHgo" } //Labasa: Video is showing Bangladesh
      ]
    };

    const numRipples = 12;
    const basePeriod = 12000;

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [ (bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255 ];
    }

    const GlobeObj = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .pointsData([])
      .pointAltitude(0)
      .pointLabel(d => d.label)
      .pointColor(d => d.color)
      .pointRadius(0.18)
      .ringsData([])
      .ringMaxRadius(d => d.maxR)
      .ringPropagationSpeed(d => d.speed)
      .ringRepeatPeriod(d => d.period)
      .ringColor(d => t => `rgba(${d.colorRGB[0]},${d.colorRGB[1]},${d.colorRGB[2]},${1 - t})`);

    GlobeObj(document.getElementById('globeViz'));
    GlobeObj.controls().autoRotate = true;
    GlobeObj.controls().autoRotateSpeed = 0.3;

    function updateForMonth(monthIndex) {
      document.getElementById('monthLabel').textContent = monthNames[monthIndex];
      const rings = [], points = [];

      for (const country of Object.keys(locations)) {
        const colorHex = bloomColors[country] ? bloomColors[country][monthIndex] : "#ffffff";
        const colorRGB = hexToRgb(colorHex);

        for (const loc of locations[country]) {
          points.push({ lat: loc.lat, lng: loc.lng, label: `${country} — ${loc.label}`, color: colorHex, videoUrl: loc.videoUrl });
          for (let i = 0; i < numRipples; i++) {
            rings.push({ lat: loc.lat, lng: loc.lng, maxR: 3.5, speed: 2, period: basePeriod / (i + 1), colorRGB: colorRGB });
          }
        }
      }
      GlobeObj.pointsData(points);
      GlobeObj.ringsData(rings);
    }

    updateForMonth(0);

    const slider = document.getElementById('monthSlider');
    slider.addEventListener('input', e => updateForMonth(parseInt(e.target.value, 10)));

    // Play / Pause
const playBtn = document.getElementById('playBtn');
let isPlaying = false, playInterval = null;

playBtn.addEventListener('click', () => {
  if (!isPlaying) {
    isPlaying = true;
    playBtn.textContent = '⏸ Pause';

    // Start month animation
    playInterval = setInterval(() => {
      let next = (parseInt(slider.value) + 1) % 12;
      slider.value = next;
      updateForMonth(next);
    }, 1000);

    // Resume spinning
    GlobeObj.controls().autoRotate = true;

  } else {
    isPlaying = false;
    playBtn.textContent = '▶ Play';

    // Stop month animation
    clearInterval(playInterval);

    // Pause spinning
    GlobeObj.controls().autoRotate = false;
  }
});


    // SCORE SYSTEM (no timer)
    let score = 0;
    const scoreDisplay = document.getElementById("score");
    const clickedLocations = new Set();

    GlobeObj.onPointClick(point => {
      if (point.videoUrl) {
        // Show video modal
        ytFrame.src = point.videoUrl.includes("youtu") ? toEmbedUrl(point.videoUrl) + "?autoplay=1&rel=0" : point.videoUrl;
        modal.classList.add('active');
      }
      if (!clickedLocations.has(point.label)) {
        clickedLocations.add(point.label);
        score += 100;
        scoreDisplay.textContent = score;
      }
    });

    // Modal handlers
    const modal = document.getElementById('videoModal');
    const ytFrame = document.getElementById('ytFrame');
    const closeBtn = document.getElementById('closeBtn');
    closeBtn.addEventListener('click', () => { modal.classList.remove('active'); ytFrame.src=""; });
    modal.addEventListener('click', e => { if (e.target===modal) { modal.classList.remove('active'); ytFrame.src=""; } });

    function toEmbedUrl(url) {
      if(url.includes("youtu")) {
        let videoId = "";
        if(url.includes("shorts/")) {
          videoId = url.split("shorts/")[1].split("?")[0];
        } else if(url.includes("watch?v=")) {
          videoId = url.split("watch?v=")[1].split("&")[0];
        } else if(url.includes("youtu.be/")) {
          videoId = url.split("youtu.be/")[1].split("?")[0];
        }
        return "https://www.youtube.com/embed/" + videoId;
      }
      return url;
    }

    // Pulse animation for points
    (function pulsePoints() {
      const t = Date.now() * 0.002;
      GlobeObj.pointRadius(0.15 + Math.abs(Math.sin(t)) * 0.06);
      requestAnimationFrame(pulsePoints);
    })();
  </script>
</body>
</html>
